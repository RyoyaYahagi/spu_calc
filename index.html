<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥½å¤©ãƒã‚¤ãƒ³ãƒˆé‚„å…ƒè¨ˆç®—æ©Ÿ</title>

    <style>
        /* ========================================
           CSSå¤‰æ•°ï¼ˆã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆï¼‰
        ======================================== */
        :root {
            --primary-color: #bf0000;
            --primary-hover: #9a0000;
            --primary-light: #fff0f0;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-muted: #666666;
            --border-color: #dddddd;
            --success-color: #28a745;
            --warning-color: #e67700;
            --info-color: #17a2b8;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Sans', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 16px;
        }

        .container {
            max-width: 540px;
            margin: 0 auto;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        h1 {
            color: var(--primary-color);
            font-size: 1.4rem;
            text-align: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary-color);
        }

        h2 {
            font-size: 1rem;
            color: var(--text-color);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        h2::before {
            content: '';
            width: 4px;
            height: 16px;
            background: var(--primary-color);
            border-radius: 2px;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .label-hint {
            font-weight: normal;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        input[type="number"],
        input[type="text"],
        input[type="date"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .input-row {
            display: flex;
            gap: 8px;
        }

        .input-row .form-group {
            flex: 1;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            width: 100%;
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        .btn-secondary {
            background-color: #eee;
            color: var(--text-color);
            font-weight: normal;
            font-size: 0.9rem;
            padding: 8px 12px;
        }

        .btn-add {
            width: 100%;
            background: none;
            border: 2px dashed var(--border-color);
            color: var(--text-muted);
            padding: 10px;
            margin-top: 8px;
        }

        .btn-add:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 0.85rem;
            font-weight: normal;
        }

        .btn-delete {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 1.2rem;
        }

        .btn-delete:hover {
            color: var(--primary-color);
        }

        /* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
        .toggle-item {
            display: flex;
            align-items: flex-start;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .toggle-item:last-child {
            border-bottom: none;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
            margin-right: 12px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked+.toggle-slider {
            background-color: var(--primary-color);
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(20px);
        }

        .toggle-content {
            flex: 1;
            min-width: 0;
        }

        .toggle-title {
            font-weight: 500;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-rate {
            color: var(--primary-color);
            font-weight: bold;
        }

        .toggle-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .toggle-actions {
            display: flex;
            align-items: center;
        }

        /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ */
        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 8px 0;
        }

        .accordion-header h2 {
            margin-bottom: 0;
        }

        .accordion-toggle {
            font-size: 1.2rem;
            color: var(--text-muted);
            transition: transform 0.3s;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .accordion-content.open {
            max-height: 2000px;
        }

        /* ãƒãƒ©ã‚½ãƒ³åº—èˆ—ãƒªã‚¹ãƒˆ */
        .shop-list {
            background: #fafafa;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
        }

        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .shop-item:last-child {
            border-bottom: none;
        }

        .shop-info {
            flex: 1;
        }

        .shop-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .shop-amount {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .shop-count-badge {
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* çµæœè¡¨ç¤º */
        .result {
            display: none;
        }

        .result.show {
            display: block;
        }

        .result-main {
            background: linear-gradient(135deg, var(--primary-color), #e63946);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
        }

        .result-row:not(:last-child) {
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .result-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .result-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .result-value.highlight {
            font-size: 1.8rem;
        }

        .breakdown {
            background: var(--primary-light);
            border-radius: 8px;
            padding: 12px;
        }

        .breakdown-title {
            font-size: 0.85rem;
            font-weight: bold;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            padding: 4px 0;
        }

        .breakdown-item.limited {
            color: var(--warning-color);
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
            padding: 16px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
        }

        .modal-footer {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .modal-footer .btn {
            flex: 1;
        }

        .footer {
            text-align: center;
            font-size: 0.75rem;
            color: #888;
            margin-top: 8px;
        }

        .mt-8 {
            margin-top: 8px;
        }

        .mt-16 {
            margin-top: 16px;
        }

        .text-muted {
            color: var(--text-muted);
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="card">
            <h1>ğŸ›’ æ¥½å¤©ãƒã‚¤ãƒ³ãƒˆé‚„å…ƒè¨ˆç®—æ©Ÿ</h1>

            <!-- åŸºæœ¬è¨­å®š -->
            <form id="calcForm">
                <div class="form-group">
                    <label for="price">å•†å“ä¾¡æ ¼ <span class="label-hint">ï¼ˆç¨è¾¼ãƒ»å††ï¼‰</span></label>
                    <input type="number" id="price" placeholder="10000" min="0" required>
                </div>

                <div class="input-row">
                    <div class="form-group">
                        <label for="basePoint">é€šå¸¸ãƒã‚¤ãƒ³ãƒˆ <span class="label-hint">%</span></label>
                        <input type="number" id="basePoint" value="1" min="0" step="0.5">
                    </div>
                    <div class="form-group">
                        <label for="spuRate">SPUåˆè¨ˆ <span class="label-hint">%</span></label>
                        <input type="number" id="spuRate" value="0" min="0" step="0.5">
                    </div>
                    <div class="form-group">
                        <label for="shopRate">ã‚·ãƒ§ãƒƒãƒ— <span class="label-hint">%</span></label>
                        <input type="number" id="shopRate" value="0" min="0" step="0.5">
                    </div>
                </div>

                <!-- ãƒã‚¤æ´»ã‚µã‚¤ãƒˆï¼ˆçµ±åˆç‰ˆï¼‰ -->
                <div class="form-group">
                    <label for="pointSiteRate">ãƒã‚¤æ´»ã‚µã‚¤ãƒˆé‚„å…ƒç‡ <span class="label-hint">% (ãƒãƒ”ã‚¿ã‚¹ãƒ»ãƒ¢ãƒƒãƒ”ãƒ¼ç­‰)</span></label>
                    <input type="number" id="pointSiteRate" value="0" min="0" step="0.1" placeholder="1.0">
                </div>
            </form>
        </div>

        <!-- ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ -->
        <div class="card">
            <div class="accordion-header" onclick="toggleAccordion('campaignAccordion', this)">
                <h2>ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</h2>
                <span class="accordion-toggle">â–¼</span>
            </div>
            <div id="campaignAccordion" class="accordion-content open">
                <div id="campaignList"></div>
                <button type="button" class="btn btn-add" onclick="openCampaignModal()">
                    ï¼‹ ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³è¿½åŠ 
                </button>
            </div>
        </div>

        <!-- ãŠè²·ã„ç‰©ãƒãƒ©ã‚½ãƒ³åº—èˆ—ç®¡ç† -->
        <div class="card" id="marathonShopCard" style="display: none;">
            <div class="accordion-header" onclick="toggleAccordion('marathonAccordion', this)">
                <h2>ãŠè²·ã„ç‰©ãƒãƒ©ã‚½ãƒ³ è³¼å…¥åº—èˆ—</h2>
                <span class="accordion-toggle">â–¼</span>
            </div>
            <div id="marathonAccordion" class="accordion-content open">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span>ç¾åœ¨ã®åº—èˆ—æ•°: <span class="shop-count-badge" id="shopCountBadge">0</span> â†’ <span
                            class="toggle-rate" id="marathonRateDisplay">+0%</span></span>
                </div>
                <div class="shop-list" id="marathonShopList">
                    <p class="text-muted" style="text-align: center; padding: 16px;">åº—èˆ—ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
                </div>
                <button type="button" class="btn btn-add" onclick="openShopModal()">
                    ï¼‹ è³¼å…¥åº—èˆ—ã‚’è¿½åŠ 
                </button>
            </div>
        </div>

        <!-- è¨ˆç®—ãƒœã‚¿ãƒ³ -->
        <button type="button" class="btn btn-primary" onclick="calculate()">
            è¨ˆç®—ã™ã‚‹
        </button>

        <!-- çµæœè¡¨ç¤º -->
        <div id="result" class="result mt-16">
            <div class="result-main">
                <div class="result-row">
                    <span class="result-label">åˆè¨ˆé‚„å…ƒç‡</span>
                    <span class="result-value" id="totalRate">0%</span>
                </div>
                <div class="result-row">
                    <span class="result-label">ç²å¾—äºˆå®šãƒã‚¤ãƒ³ãƒˆ</span>
                    <span class="result-value highlight" id="totalPoints">0 pt</span>
                </div>
                <div class="result-row">
                    <span class="result-label">å®Ÿè³ªä¾¡æ ¼</span>
                    <span class="result-value" id="effectivePrice">0 å††</span>
                </div>
            </div>

            <div class="breakdown">
                <div class="breakdown-title">ğŸ“Š ãƒã‚¤ãƒ³ãƒˆå†…è¨³</div>
                <div id="breakdownList"></div>
            </div>
        </div>

        <p class="footer mt-16">â€» å®Ÿéš›ã®ç²å¾—ãƒã‚¤ãƒ³ãƒˆã¯å„ç¨®ä¸Šé™ç­‰ã«ã‚ˆã‚Šç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</p>
    </div>

    <!-- ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="campaignModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³è¿½åŠ </span>
                <button class="modal-close" onclick="closeCampaignModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å</label>
                <input type="text" id="campaignName" placeholder="è¶…ãƒã‚¤ãƒ³ãƒˆãƒãƒƒã‚¯ç¥­">
            </div>
            <div class="input-row">
                <div class="form-group">
                    <label>å€ç‡ (%)</label>
                    <input type="number" id="campaignRate" placeholder="5" min="0" step="0.5">
                </div>
                <div class="form-group">
                    <label>ä¸Šé™ãƒã‚¤ãƒ³ãƒˆ</label>
                    <input type="number" id="campaignMaxPoints" placeholder="7000" min="0">
                </div>
            </div>
            <div class="input-row">
                <div class="form-group">
                    <label>é–‹å§‹æ—¥</label>
                    <input type="date" id="campaignStartDate">
                </div>
                <div class="form-group">
                    <label>çµ‚äº†æ—¥</label>
                    <input type="date" id="campaignEndDate">
                </div>
            </div>
            <div class="form-group">
                <label>æœŸé–“å†…ã®ç´¯è¨ˆè³¼å…¥é‡‘é¡ <span class="label-hint">ï¼ˆå††ï¼‰</span></label>
                <input type="number" id="campaignSpentAmount" placeholder="0" min="0" value="0">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCampaignModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="saveCampaign()">è¿½åŠ </button>
            </div>
        </div>
    </div>

    <!-- è³¼å…¥åº—èˆ—è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="shopModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">è³¼å…¥åº—èˆ—ã‚’è¿½åŠ </span>
                <button class="modal-close" onclick="closeShopModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>åº—èˆ—å</label>
                <input type="text" id="shopName" placeholder="â—‹â—‹ã‚·ãƒ§ãƒƒãƒ—">
            </div>
            <div class="form-group">
                <label>è³¼å…¥é‡‘é¡ <span class="label-hint">ï¼ˆç¨è¾¼ãƒ»å††ï¼‰â€»1,000å††ä»¥ä¸Šã§1åº—èˆ—ã‚«ã‚¦ãƒ³ãƒˆ</span></label>
                <input type="number" id="shopAmount" placeholder="3000" min="0">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeShopModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="saveShop()">è¿½åŠ </button>
            </div>
        </div>
    </div>

    <script>
        /* ========================================
           ãƒ‡ãƒ¼ã‚¿ç®¡ç†
        ======================================== */

        const STORAGE_KEY = 'rakuten_point_calculator_v2';

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿
        const defaultData = {
            campaigns: [
                {
                    id: 'marathon',
                    name: 'ãŠè²·ã„ç‰©ãƒãƒ©ã‚½ãƒ³',
                    rate: 0,  // åº—èˆ—æ•°ã‹ã‚‰è‡ªå‹•è¨ˆç®—
                    maxPoints: 7000,
                    enabled: false,
                    startDate: '',
                    endDate: '',
                    spentAmount: 0,
                    isPreset: true,
                    isMarathon: true  // ãƒãƒ©ã‚½ãƒ³å°‚ç”¨ãƒ•ãƒ©ã‚°
                },
                {
                    id: 'fiveZero',
                    name: '5ã¨0ã®ã¤ãæ—¥',
                    rate: 1,  // ä¿®æ­£: 2% â†’ 1%
                    maxPoints: 3000,
                    enabled: false,
                    startDate: '',
                    endDate: '',
                    spentAmount: 0,
                    isPreset: true
                },
                {
                    id: 'victory',
                    name: 'å‹ã£ãŸã‚‰å€',
                    rate: 1,
                    maxPoints: 1000,
                    enabled: false,
                    startDate: '',
                    endDate: '',
                    spentAmount: 0,
                    isPreset: true
                },
                {
                    id: 'shop39',
                    name: '39ã‚·ãƒ§ãƒƒãƒ—',
                    rate: 1,
                    maxPoints: null,
                    enabled: false,
                    startDate: '',
                    endDate: '',
                    spentAmount: 0,
                    isPreset: true
                },
            ],
            // ãƒãƒ©ã‚½ãƒ³æœŸé–“å†…ã®è³¼å…¥åº—èˆ—ãƒªã‚¹ãƒˆ
            marathonShops: []
        };

        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: marathonShopsãŒãªã„å ´åˆã¯è¿½åŠ 
                if (!data.marathonShops) {
                    data.marathonShops = [];
                }
                return data;
            }
            return JSON.parse(JSON.stringify(defaultData));
        }

        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        let appData = loadData();

        /* ========================================
           ãƒãƒ©ã‚½ãƒ³åº—èˆ—æ•°ã‹ã‚‰å€ç‡ã‚’è¨ˆç®—
           1åº—èˆ—=+1%, 2åº—èˆ—=+2%, ... æœ€å¤§10åº—èˆ—=+9%
        ======================================== */
        function calculateMarathonRate() {
            // 1,000å††ä»¥ä¸Šã®åº—èˆ—ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ
            const qualifiedShops = appData.marathonShops.filter(shop => shop.amount >= 1000);
            const shopCount = qualifiedShops.length;

            // 1åº—èˆ—ç›®ã¯é€šå¸¸ãƒã‚¤ãƒ³ãƒˆãªã®ã§ã€2åº—èˆ—ç›®ã‹ã‚‰+1%ã€æœ€å¤§10åº—èˆ—ã§+9%
            // ã¤ã¾ã‚Š (åº—èˆ—æ•° - 1) ãŒè¿½åŠ å€ç‡ã€æœ€å¤§9%
            const rate = Math.min(Math.max(shopCount - 1, 0), 9);
            return { shopCount, rate };
        }

        // ãƒãƒ©ã‚½ãƒ³è³¼å…¥åº—èˆ—ã®åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
        function calculateMarathonSpentAmount() {
            return appData.marathonShops.reduce((sum, shop) => sum + shop.amount, 0);
        }

        /* ========================================
           UIæç”»
        ======================================== */

        function renderCampaigns() {
            const container = document.getElementById('campaignList');
            container.innerHTML = '';

            appData.campaigns.forEach((campaign, index) => {
                let displayRate = campaign.rate;
                let metaText = '';

                // ãƒãƒ©ã‚½ãƒ³ã®å ´åˆã¯åº—èˆ—æ•°ã‹ã‚‰å€ç‡ã‚’è¨ˆç®—
                if (campaign.isMarathon) {
                    const { shopCount, rate } = calculateMarathonRate();
                    displayRate = rate;
                    metaText = `${shopCount}åº—èˆ— / ä¸Šé™: ${formatNumber(campaign.maxPoints)}pt`;
                } else {
                    const remainingPoints = calculateRemainingPoints(campaign);
                    metaText = buildCampaignMeta(campaign, remainingPoints);
                }

                container.innerHTML += `
                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" ${campaign.enabled ? 'checked' : ''} 
                                   onchange="toggleCampaign(${index}, this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="toggle-content">
                            <div class="toggle-title">
                                ${campaign.name}
                                <span class="toggle-rate">+${displayRate}%</span>
                            </div>
                            <div class="toggle-meta">${metaText}</div>
                        </div>
                        <div class="toggle-actions">
                            ${!campaign.isPreset ? `<button class="btn-delete" onclick="deleteCampaign(${index})">Ã—</button>` : ''}
                        </div>
                    </div>
                `;
            });
        }

        function buildCampaignMeta(campaign, remainingPoints) {
            let parts = [];
            if (campaign.maxPoints) {
                parts.push(`ä¸Šé™: ${formatNumber(campaign.maxPoints)}pt`);
                if (remainingPoints !== null && campaign.spentAmount > 0) {
                    parts.push(`æ®‹: ${formatNumber(remainingPoints)}pt`);
                }
            }
            if (campaign.startDate && campaign.endDate) {
                parts.push(`${campaign.startDate} ã€œ ${campaign.endDate}`);
            }
            return parts.length > 0 ? parts.join(' / ') : 'ä¸Šé™ãªã—';
        }

        function calculateRemainingPoints(campaign) {
            if (!campaign.maxPoints || !campaign.spentAmount) return null;
            const earnedPoints = Math.floor(campaign.spentAmount * (campaign.rate / 100));
            return Math.max(0, campaign.maxPoints - earnedPoints);
        }

        // ãƒãƒ©ã‚½ãƒ³åº—èˆ—ãƒªã‚¹ãƒˆã‚’æç”»
        function renderMarathonShops() {
            const container = document.getElementById('marathonShopList');
            const { shopCount, rate } = calculateMarathonRate();

            // ãƒãƒƒã‚¸ã¨å€ç‡ã‚’æ›´æ–°
            document.getElementById('shopCountBadge').textContent = shopCount;
            document.getElementById('marathonRateDisplay').textContent = `+${rate}%`;

            if (appData.marathonShops.length === 0) {
                container.innerHTML = '<p class="text-muted" style="text-align: center; padding: 16px;">åº—èˆ—ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>';
                return;
            }

            container.innerHTML = appData.marathonShops.map((shop, index) => {
                const isQualified = shop.amount >= 1000;
                return `
                    <div class="shop-item">
                        <div class="shop-info">
                            <div class="shop-name">${shop.name} ${isQualified ? 'âœ“' : '<span style="color: var(--warning-color);">â€»1000å††æœªæº€</span>'}</div>
                            <div class="shop-amount">${formatNumber(shop.amount)}å††</div>
                        </div>
                        <button class="btn-delete" onclick="deleteShop(${index})">Ã—</button>
                    </div>
                `;
            }).join('');

            // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒªã‚¹ãƒˆã‚‚æ›´æ–°
            renderCampaigns();
        }

        // ãƒãƒ©ã‚½ãƒ³ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤º
        function updateMarathonCardVisibility() {
            const marathonCampaign = appData.campaigns.find(c => c.isMarathon);
            const card = document.getElementById('marathonShopCard');
            if (marathonCampaign && marathonCampaign.enabled) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        }

        /* ========================================
           ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
        ======================================== */

        function toggleAccordion(id, header) {
            const content = document.getElementById(id);
            const toggle = header.querySelector('.accordion-toggle');
            content.classList.toggle('open');
            toggle.textContent = content.classList.contains('open') ? 'â–¼' : 'â–¶';
        }

        function toggleCampaign(index, enabled) {
            appData.campaigns[index].enabled = enabled;
            saveData(appData);

            // ãƒãƒ©ã‚½ãƒ³ã®å ´åˆã¯ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤ºã‚’æ›´æ–°
            if (appData.campaigns[index].isMarathon) {
                updateMarathonCardVisibility();
            }
        }

        function deleteCampaign(index) {
            if (confirm('ã“ã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                appData.campaigns.splice(index, 1);
                saveData(appData);
                renderCampaigns();
            }
        }

        function deleteShop(index) {
            if (confirm('ã“ã®åº—èˆ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                appData.marathonShops.splice(index, 1);
                saveData(appData);
                renderMarathonShops();
            }
        }

        /* ========================================
           ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
        ======================================== */

        function openCampaignModal() {
            document.getElementById('campaignModal').classList.add('show');
            document.getElementById('campaignName').value = '';
            document.getElementById('campaignRate').value = '';
            document.getElementById('campaignMaxPoints').value = '';
            document.getElementById('campaignStartDate').value = '';
            document.getElementById('campaignEndDate').value = '';
            document.getElementById('campaignSpentAmount').value = '0';
        }

        function closeCampaignModal() {
            document.getElementById('campaignModal').classList.remove('show');
        }

        function saveCampaign() {
            const name = document.getElementById('campaignName').value.trim();
            const rate = parseFloat(document.getElementById('campaignRate').value) || 0;
            const maxPoints = parseInt(document.getElementById('campaignMaxPoints').value) || null;
            const startDate = document.getElementById('campaignStartDate').value;
            const endDate = document.getElementById('campaignEndDate').value;
            const spentAmount = parseInt(document.getElementById('campaignSpentAmount').value) || 0;

            if (!name) {
                alert('ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            appData.campaigns.push({
                id: 'custom_' + Date.now(),
                name,
                rate,
                maxPoints,
                enabled: true,
                startDate,
                endDate,
                spentAmount,
                isPreset: false
            });

            saveData(appData);
            renderCampaigns();
            closeCampaignModal();
        }

        function openShopModal() {
            document.getElementById('shopModal').classList.add('show');
            document.getElementById('shopName').value = '';
            document.getElementById('shopAmount').value = '';
        }

        function closeShopModal() {
            document.getElementById('shopModal').classList.remove('show');
        }

        function saveShop() {
            const name = document.getElementById('shopName').value.trim();
            const amount = parseInt(document.getElementById('shopAmount').value) || 0;

            if (!name) {
                alert('åº—èˆ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (amount <= 0) {
                alert('è³¼å…¥é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            appData.marathonShops.push({
                id: 'shop_' + Date.now(),
                name,
                amount
            });

            saveData(appData);
            renderMarathonShops();
            closeShopModal();
        }

        /* ========================================
           è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
        ======================================== */

        function calculate() {
            const price = parseFloat(document.getElementById('price').value) || 0;
            const basePoint = parseFloat(document.getElementById('basePoint').value) || 0;
            const spuRate = parseFloat(document.getElementById('spuRate').value) || 0;
            const shopRate = parseFloat(document.getElementById('shopRate').value) || 0;
            const pointSiteRate = parseFloat(document.getElementById('pointSiteRate').value) || 0;

            if (price <= 0) {
                alert('å•†å“ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const breakdown = [];
            let totalPoints = 0;
            let totalRate = 0;

            // é€šå¸¸ãƒã‚¤ãƒ³ãƒˆ
            const basePoints = Math.floor(price * (basePoint / 100));
            breakdown.push({ name: 'é€šå¸¸ãƒã‚¤ãƒ³ãƒˆ', points: basePoints, rate: basePoint });
            totalPoints += basePoints;
            totalRate += basePoint;

            // SPU
            if (spuRate > 0) {
                const spuPoints = Math.floor(price * (spuRate / 100));
                breakdown.push({ name: 'SPU', points: spuPoints, rate: spuRate });
                totalPoints += spuPoints;
                totalRate += spuRate;
            }

            // ã‚·ãƒ§ãƒƒãƒ—ãƒã‚¤ãƒ³ãƒˆ
            if (shopRate > 0) {
                const shopPoints = Math.floor(price * (shopRate / 100));
                breakdown.push({ name: 'ã‚·ãƒ§ãƒƒãƒ—ãƒã‚¤ãƒ³ãƒˆ', points: shopPoints, rate: shopRate });
                totalPoints += shopPoints;
                totalRate += shopRate;
            }

            // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³
            appData.campaigns.forEach(campaign => {
                if (!campaign.enabled) return;

                let currentRate = campaign.rate;
                let currentSpentAmount = campaign.spentAmount;

                // ãƒãƒ©ã‚½ãƒ³ã®å ´åˆã¯åº—èˆ—æ•°ã‹ã‚‰å€ç‡ã‚’è¨ˆç®—
                if (campaign.isMarathon) {
                    const { rate } = calculateMarathonRate();
                    currentRate = rate;
                    currentSpentAmount = calculateMarathonSpentAmount();
                }

                if (currentRate <= 0) return;

                // æœŸé–“ãƒã‚§ãƒƒã‚¯
                if (campaign.startDate && campaign.endDate) {
                    const today = new Date().toISOString().split('T')[0];
                    if (today < campaign.startDate || today > campaign.endDate) {
                        return;
                    }
                }

                let earnedPoints = Math.floor(price * (currentRate / 100));
                let isLimited = false;

                // ä¸Šé™ãƒã‚§ãƒƒã‚¯
                if (campaign.maxPoints) {
                    const alreadyEarned = Math.floor(currentSpentAmount * (currentRate / 100));
                    const remaining = Math.max(0, campaign.maxPoints - alreadyEarned);

                    if (remaining <= 0) {
                        return; // ä¸Šé™åˆ°é”æ¸ˆã¿
                    }
                    if (earnedPoints > remaining) {
                        earnedPoints = remaining;
                        isLimited = true;
                    }
                }

                breakdown.push({
                    name: campaign.name,
                    points: earnedPoints,
                    rate: currentRate,
                    isLimited
                });
                totalPoints += earnedPoints;
                totalRate += currentRate;
            });

            // ãƒã‚¤æ´»ã‚µã‚¤ãƒˆ
            if (pointSiteRate > 0) {
                const sitePoints = Math.floor(price * (pointSiteRate / 100));
                breakdown.push({ name: 'ãƒã‚¤æ´»ã‚µã‚¤ãƒˆ', points: sitePoints, rate: pointSiteRate });
                totalPoints += sitePoints;
                totalRate += pointSiteRate;
            }

            // çµæœã‚’è¡¨ç¤º
            document.getElementById('totalRate').textContent = totalRate.toFixed(1) + '%';
            document.getElementById('totalPoints').textContent = formatNumber(totalPoints) + ' pt';
            document.getElementById('effectivePrice').textContent = formatNumber(price - totalPoints) + ' å††';

            // å†…è¨³ã‚’è¡¨ç¤º
            const breakdownContainer = document.getElementById('breakdownList');
            breakdownContainer.innerHTML = breakdown.map(item => `
                <div class="breakdown-item ${item.isLimited ? 'limited' : ''}">
                    <span>${item.name} (${item.rate}%)</span>
                    <span>${formatNumber(item.points)} pt ${item.isLimited ? '(ä¸Šé™)' : ''}</span>
                </div>
            `).join('');

            document.getElementById('result').classList.add('show');
        }

        function formatNumber(num) {
            return num.toLocaleString('ja-JP');
        }

        /* ========================================
           åˆæœŸåŒ–
        ======================================== */
        document.addEventListener('DOMContentLoaded', () => {
            renderCampaigns();
            renderMarathonShops();
            updateMarathonCardVisibility();
        });
    </script>
</body>

</html>